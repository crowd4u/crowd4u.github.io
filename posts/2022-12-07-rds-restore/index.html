<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="初めまして、融合知能デザイン研究室に仮配属中のギルドです。(留年しなければ「仮」がとれるはず。。。) 融合知能デザイン研究室で開発しているNe"><title>RDS上のDBのデータをローカルで同期できる環境を作った話</title><link rel=canonical href=http://crowd4u.github.io/posts/2022-12-07-rds-restore/><link rel=stylesheet href=/scss/style.min.fc8bf3a7b239efc4b4a5d0e6baf39d16cb950b1ccf79ad20c92640524b77531e.css><meta property="og:title" content="RDS上のDBのデータをローカルで同期できる環境を作った話"><meta property="og:description" content="融合知能デザイン研究室のエンジニアブログです"><meta property="og:url" content="http://crowd4u.github.io/posts/2022-12-07-rds-restore/"><meta property="og:site_name" content="crowd4u tech blog"><meta name=twitter:card content="summary"><meta property="og:type" content="article"><meta property="article:section" content="Posts"><meta property="article:tag" content="NextCrowd4u"><meta property="article:tag" content="AWS"><meta property="article:published_time" content="2022-12-01T14:54:39+09:00"><meta property="article:modified_time" content="2022-12-01T14:54:39+09:00"><meta property="og:image" content="https://fusioncomplab.org/images/slideshow/01.jpg"><meta name=twitter:title content="RDS上のDBのデータをローカルで同期できる環境を作った話"><meta property="og:description" content="融合知能デザイン研究室のエンジニアブログです"><meta name=twitter:card content="summary_large_image"><meta property="og:image" content="https://fusioncomplab.org/images/slideshow/01.jpg"></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=メニューを開く・閉じる>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu8481d02a2698fd6b4a5b48cca9d12a3d_939431_300x0_resize_box_3.png width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>crowd4u tech blog</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>ダークモード</span></li></div></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/posts/2022-12-07-rds-restore/>RDS上のDBのデータをローカルで同期できる環境を作った話</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Dec 01, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>読了時間: 6分</time></div></footer><div class=article-author><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><a href=/author/gild>ギルド</a></div><aside id=toc><p>目次</p><nav id=TableOfContents><ul><li><a href=#nextcrowd4un4uについて>NextCrowd4u(N4U)について</a></li><li><a href=#n4uの開発現場で発生していたﾁｮｯﾄ面倒な事>N4Uの開発現場で発生していたﾁｮｯﾄ面倒な事</a></li><li><a href=#やったこと>やったこと</a><ul><li><a href=#n4uサーバーdbを定期的にダンプする>N4Uサーバー：DBを定期的にダンプする</a></li><li><a href=#ローカル環境dbを踏み台からダウンロードしてリストアする>ローカル環境：DBを踏み台からダウンロードしてリストアする</a></li></ul></li><li><a href=#おわりに>おわりに</a></li></ul></nav></aside></div></header><section class=article-content><p>初めまして、融合知能デザイン研究室に仮配属中のギルドです。(留年しなければ「仮」がとれるはず。。。)<br>融合知能デザイン研究室で開発しているNextCrowd4uの開発チームに最近加わったため、加入後に初めて行ったことについて書いていきたいと思います。</p><h2 id=nextcrowd4un4uについて>NextCrowd4u(N4U)について</h2><p>まだブログも創設から間もないという事で、NextCrowd4Uについてザックリ説明していこうと思います。
NextCrowd4u(以下N4U)は、「世界をより良い場所にするためのマイクロタスクを実行するための非営利プラットフォーム」として2008年ごろから稼働している<a class=link href=https://crowd4u.org/ja/ target=_blank rel=noopener>Crowd4u</a>の後継システムです。
N4U開発チームで具体的にどんなことを行ってきたかについては、<a class=link href=../2022-11-30-intro/>こちらの記事</a>をご覧ください。</p><h2 id=n4uの開発現場で発生していたﾁｮｯﾄ面倒な事>N4Uの開発現場で発生していたﾁｮｯﾄ面倒な事</h2><p>さて、実際の開発ではサーバー上のコードを直接編集。。。するわけでは当然なく、基本はローカルの環境で開発して、GitHubでコミットやらレビューやらしてからデプロイするわけですが、そうなると開発やテストが行いやすいため、実際のサービスのデータをローカルでも扱いたいというニーズが出てきます。
N4UはAWSをサーバーのインフラとして使用しており、DBもAmazon RDS for MySQLを使っています。
これまでは、RDS上にある本番環境のデータをローカル環境で使用するために、踏み台サーバーを2回通してSCPコマンドを使ってデータを取得する必要がありました。
このような環境はテストや開発において支障がでていたとのことで、もう少し手軽に本番とローカルのデータを同期したいというニーズが生まれました。</p><h2 id=やったこと>やったこと</h2><p>やったことは非常にシンプルで、N4Uを稼働しているサーバーから、1日1回DBをダンプして踏み台サーバーに送るような環境を作成します。(下図)
そして、ローカルでリストア用のスクリプトを実行することで、踏み台サーバーにアクセスし、ダンプされたDBをダウンロードして、ローカルのデータベースにリストアするようにしました。<br><figure><img src=/posts/2022-12-07/n4u-db-restore.drawio.png alt=図1 width=75%></figure></p><p>これを実現するためにやったこととしては</p><ul><li>N4Uサーバー<ol><li>RDSのDBをダンプし、踏み台に送信するシェルスクリプトを作成する(dump.sh)</li><li>上記のスクリプトを定期的に実行する(cron)</li></ol></li><li>踏み台サーバー<ol><li>AWSでEC2の環境を新しく作成する</li><li>nginxを導入し、ベーシック認証ができるようにする</li></ol></li><li>ローカル環境<br>以下のようなシェルスクリプトを作成する。(restore.sh)<ol><li>踏み台サーバーからDBをダウンロードする</li><li>ローカルのDBにリストアする</li></ol></li></ul><p>踏み台サーバーの設定に関しては、私が書くよりも分かりやすい記事がたくさんあるかと思います。<br>そのため、ここからはDBのダンプスクリプトとリストアスクリプトについて書いていきます。</p><h3 id=n4uサーバーdbを定期的にダンプする>N4Uサーバー：DBを定期的にダンプする</h3><p><strong>1. DBをダンプする<code>dump.sh</code>を作成する</strong><br>というわけで、以下のようなダンプスクリプトを作成しました。データベースの容量がある程度大きいことが想定されますのでgzipを使用して圧縮をしています。</p><div class=highlight name=dump.sh><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># RDSからDBをダンプする(dump.sqlを作成)</span>
</span></span><span style=display:flex><span>mysqldump -h <span style=color:#f92672>{</span>RDSのホスト名<span style=color:#f92672>}</span> -P <span style=color:#f92672>{</span>ポート番号<span style=color:#f92672>}</span> -u <span style=color:#f92672>{</span>ユーザー名<span style=color:#f92672>}</span> -p<span style=color:#f92672>{</span>パスワード<span style=color:#f92672>}</span> -p <span style=color:#f92672>{</span>DB名<span style=color:#f92672>}</span> &gt; dump.sql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># gzipに圧縮</span>
</span></span><span style=display:flex><span>gzip dump.sql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># scpコマンドで踏み台に送信する</span>
</span></span><span style=display:flex><span>scp -i <span style=color:#f92672>{</span>秘密鍵のパス<span style=color:#f92672>}</span> dump.sql.gz <span style=color:#f92672>{</span>踏み台のホスト名<span style=color:#f92672>}</span>:<span style=color:#f92672>{</span>踏み台のダウンロード先のパス<span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>パス等が多いという事もあり、文字だらけですが以上のようなスクリプトを作成しました。<br>注意する点としては、パスワードは<code>-p</code>の後に空白を入れずに入力するという事です。空白を入れてしまうとDB名として認識されてしまいます。<br>また、私の環境での話ですが、パスワードをDB名より先に入力しないと<code>-p {DB名}</code>の部分がパスワードとして認識されてしまい、ダンプできないという現象が発生しました。<br>そのため、パスワードを先に記述してエラーを回避しています。</p><p><strong>2. <code>dump.sh</code>を定期的に実行する</strong><br>次にこのスクリプトを定期的に実行していきます。<br>AWSということで、Amazon EventBridge！と行きたいところですが、AWSを使用した開発経験が過去に皆無だったこともあり、無難にcronで定期実行することにしました。<br>コマンドラインで以下をたたき、crontabを開きます。</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -e
</span></span></code></pre></td></tr></table></div></div><p>次にcronのスクリプトを書いていきます。<br>以下は毎日01時00分にシェルスクリプトを実行するスクリプトです。
パスは適宜書き換えてください(ex. <code>~/tools/dump.sh</code>)</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ae81ff>0</span> <span style=color:#ae81ff>01</span> * * * sh dump.sh
</span></span></code></pre></td></tr></table></div></div><p>ちなみにcronの時間指定は<code>{分} {時} {日} {月} {曜日}</code>で、指定しない項目には<code>*</code>を指定します。<br>以上の設定でN4Uサーバー上で毎日DBをダンプする環境が出来上がりました！</p><h3 id=ローカル環境dbを踏み台からダウンロードしてリストアする>ローカル環境：DBを踏み台からダウンロードしてリストアする</h3><p>N4UサーバーからDBをダンプして踏み台に送信できるようになったので、ローカル環境でリストアするスクリプトを書いていきます。
ちなみにダウンロードには<code>wget</code>コマンドを使用して行っていきます。
また、先述した通り踏み台サーバーはベーシック認証を設定しているため、wgetのオプションで指定し、ローカル環境としてDockerを使用しているためDockerコンテナのMySQLにリストアしていきます。</p><div class=highlight name=restore.sh><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e># DBをwgetでベーシック認証を挟んでダウンロードする</span>
</span></span><span style=display:flex><span>wget -P <span style=color:#f92672>{</span>ダウンロード先のパス<span style=color:#f92672>}</span> --http-user<span style=color:#f92672>={</span>ユーザー名<span style=color:#f92672>}</span> --http-passwd<span style=color:#f92672>={</span>パスワード<span style=color:#f92672>}</span> http://<span style=color:#f92672>{</span>踏み台のIPアドレス<span style=color:#f92672>}</span>:<span style=color:#f92672>{</span>ポート番号<span style=color:#f92672>}</span>/dump.sql.gz
</span></span><span style=display:flex><span><span style=color:#75715e># gzip化されているので解凍する</span>
</span></span><span style=display:flex><span>gunzip -f dump.sql.gz
</span></span><span style=display:flex><span><span style=color:#75715e># Dockerコンテナ内のSQLにリストアする</span>
</span></span><span style=display:flex><span>cat dump.sql | docker-compose -T <span style=color:#f92672>{</span>コンテナ名<span style=color:#f92672>}</span> mysql -u <span style=color:#f92672>{</span>ユーザー名<span style=color:#f92672>}</span> -p<span style=color:#f92672>{</span>パスワード<span style=color:#f92672>}</span> -p <span style=color:#f92672>{</span>DB名<span style=color:#f92672>}</span>
</span></span></code></pre></td></tr></table></div></div><p>以上で<code>restore.sh</code>も完成しました！<br>以上のスクリプトをローカル環境で実行することで(<code>bash restore.sh</code>)、ローカル環境に本番環境のデータが同期されるようになりました！</p><h2 id=おわりに>おわりに</h2><p>以上が私がN4Uの開発チームに入ってからの初めての仕事になります。今後、更に開発に携わっていくことになるかと思いますので、このブログへのアウトプットも含めて頑張っていきたいです。
ここまで拙文にお付き合いいただきありがとうございました！</p></section><footer class=article-footer><section class=article-tags><a href=/tags/nextcrowd4u/>NextCrowd4u</a>
<a href=/tags/aws/>AWS</a></section></footer></article><footer class=site-footer><section class=copyright>&copy;
2022 crowd4u tech blog</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>テーマ <b><a href=https://github.com/crowd4u/hugo-theme-stack target=_blank rel=noopener data-version=3.16.0>Stack</a></b> は <span><a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> and FusionCompLab</span> によって設計されています。</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>